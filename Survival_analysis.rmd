---
title: "R survival analysis example"
output: 
  html_document: 
    theme: united 
    toc: yes 
    number_sections: true 
    toc_float: true 
editor_options:  
  chunk_output_type: console
--- 

```{r include = FALSE} 
# no warning or message display in the html file 
knitr::opts_chunk$set(message=FALSE, warning=FALSE, eval=TRUE, echo=TRUE) 
```
# load the libraries and dataset

## Libraries

The most used libraries are:

- `tidyverse`: this library pack (it includes multiple libraries) provides the functions to manipulate datasets such as filter, mutate, select, arrange, group_by, summarize and etc. The most used library is `dplyr`, but I also use `tidyr` and `ggplot2`, so it is easier to just load them together in one com

- `survival` and `survminer`: the K-M plots are generated by the two packages.

- `knitr` and `kableExtra`: For me, they are mainly used for table display. `knitr` has much more functions to tweak the display our HTML/PDF output.

- `rlang`: this is used with `dplyr` to manipulate dataframe columns with variables.

The core functions we'll use out of the survival package include:

- `Surv()`: Creates a survival object.
- `survfit()` or `surv_fit()`: Fits a survival curve using either a formula, of from a previously fitted Cox model. Note that 
- `coxph()`: Fits a Cox proportional hazards regression model.


```{r loading_libraries}
library(tidyverse)
library(survival)
library(survminer)
library(knitr)
library(kableExtra)
library(rlang)
library(ggpubr)
```

## Dataset 

The dataset `lung` we are using in the example is also from the package `survival`. 

1. `inst`: Institution code
1. **`time`: Survival time in days**
1. **`status`: censoring status 1=censored, 2=dead**
1. `age`: Age in years
1. **`sex`: Male=1 Female=2**
1. `ph.ecog`: ECOG performance score (0=good 5=dead)
1. `ph.karno`: Karnofsky performance score as rated by physician
1. `pat.karno`: Karnofsky performance score as rated by patient
1. `meal.cal`: Calories consumed at meals
1. `wt.loss`: Weight loss in last six months

Let's add some more columns to the dataset:
1. Convert the column `sex` from value `1`/`2` to `Male`/`Female`. Set `Male` as the reference. 
1. Divide the age into two groups by its median. Set `Young` as the reference.

Setting ref level is required as in Cox model we usually need to run the statistical analysis for pre-defined contrasts.

```{r data_manipulation}
lung_dataset = lung %>% 
  mutate(sex = ifelse(sex == 1, "Male", "Female"),
         age_group = ifelse(age < median(age, na.rm = TRUE), "Young", "Old")) %>% 
  mutate(sex = fct_relevel(sex, "Male"),
         age_group = fct_relevel(age_group, "Young"))
```

# Kaplan-Meier plot

## One Kaplan-Meier plot 
```{r One_KM_plot}

fit <- surv_fit(Surv(time, status) ~ sex, data = lung_dataset) 
ggsurvplot(fit,
           risk.table = TRUE, tables.y.text = FALSE, break.x.by = 100, 
            pval = TRUE, surv.median.line = "hv",  
           legend.title = "sex", legend.labs = levels(lung_dataset$sex),
           title = "Kaplan-Meier Curve for Lung Cancer Survival")

```

Note that here we use `surv_fit` rather than the standard `survfit` as `surv_fit`is a wrapper of `survfit` with more supports.

## Mulitiple Kaplan-Meier plots

When it comes to mulitple plots, we can save each KM plot into a list and use `arrange_ggsurvplots` function.

Here we want to draw the KM plots based on the variable sex and age_group.

```{r Mulitiple_KM_plots, fig.width = 12}

KM_plots = list()
i = 1

for (strata_variable in c('sex', 'age_group')){
  surv_formula = paste0("Surv(time, status)~", strata_variable) %>% 
    as.formula()
  
  fit = surv_fit(surv_formula, data = lung_dataset)
  
  KM_plots[[i]] = ggsurvplot(fit,
                             risk.table = TRUE, tables.y.text = FALSE, break.x.by = 100, 
                             pval = TRUE, surv.median.line = "hv", 
                             legend.title = strata_variable, 
                             legend.labs = levels(lung_dataset[, strata_variable]))
  i = i+1
}

arrange_ggsurvplots(KM_plots,risk.table.height = 0.3, title = 'Kaplan-Meier Curve for Lung Cancer Survival') 

```

# Median survival time

```{r Median_survival_time}
#---- define the formula ---- 
surv_formula = as.formula("Surv(time, status) ~ sex")
fit = surv_fit(formula = surv_formula, data = lung_dataset, conf.type = "log-log") 

#---- get the median ---- 
surv_result= summary(fit)$table %>% data.frame 
surv_median = cbind("Feature" = rownames(surv_result), surv_result) %>%  
  mutate(`Median [95% CI]` = paste0(median,' [', round(X0.95LCL, 1), ', ', round(X0.95UCL, 1), ']')) %>%  
  select(Feature, records, events, `Median [95% CI]`) 

kable(surv_median, row.names = FALSE) %>% kable_styling()
```

# Survival probability at given time

```{r survival_p_given_time}
#---- define the formula ---- 
given_time = 300

strata_variable = "sex"
surv_formula = paste0("Surv(time, status)~", strata_variable) %>% 
    as.formula()
fit = surv_fit(formula = surv_formula, data = lung_dataset, conf.type = "log-log") 

survival_p_raw = summary(fit, times =given_time)

survival_p = data.frame(
    Feature = survival_p_raw$strata, 
    time = survival_p_raw$time, 
    risk = survival_p_raw$n.risk, 
    events = survival_p_raw$n.event, 
    survival_rate = survival_p_raw$surv, 
    lower_CI = survival_p_raw$lower, 
    upper_CI = survival_p_raw$upper) %>%  
  mutate_if(is.numeric, round, 3) %>%  
  mutate(survival_rate_95CI = paste0(survival_rate, ' [', lower_CI, ', ', upper_CI,']')) %>%  
  select(-survival_rate, -lower_CI, -upper_CI)  

kable(survival_p) %>% kable_styling() 
```

# Cox model to get HR median

```{r cox_model}
#---- define the formula ---- 

strata_variable = "sex"
ref_level = levels(lung_dataset[, strata_variable])[1]
surv_formula = paste0("Surv(time, status)~", strata_variable) %>% 
    as.formula()

#--- get the cox model ---- 

cox_model = coxph(formula = surv_formula, data=lung_dataset, method = 'efron')
cox_model_result = summary(cox_model) 
cox_HR_CI = cox_model_result$conf.int
cox_result = data.frame(Contrast = rownames(cox_HR_CI), 
                              Median = cox_HR_CI[, 'exp(coef)'],  
                              Lower95 = cox_HR_CI[, 'lower .95'],  
                              Upper95 = cox_HR_CI[, 'upper .95'],   
                              Pvalue = cox_model_result$coefficients[,'Pr(>|z|)']) %>% 
  mutate_if(is.numeric, round, 3) %>% 
  mutate(Contrast = gsub(pattern = paste0(strata_variable,"(.+)"), 
                         replacement = paste0(strata_variable, ": \\1 vs. ", ref_level), 
                         Contrast))

kable(cox_result) %>% kable_styling()

```

# Box plot
```{r box_plot}
lung_dataset %>%  
  ggboxplot(x='age_group', 
            y='time', 
            facet.by = 'sex', 
            add = 'jitter', 
            color = 'age_group')+ 
  stat_compare_means() + ylab('time') 
```

# Some data manipulation tips

## `dplyr` library with variable

When we are manipulate a dataset with `dplyr`, we usually see something like `mutate(lung_dataset, new_age = scale(age))`. Here `new_age` and `age` are the column names in the dataset `lung_dataset`. This is called non-standard evaluation. So if we have many columns which need the same function, we can not do something like `mutate(lung_dataset, new_column = scale(old_column))` as `dplyr` tries to find the column called `old_column`. `dplyr` needs us to use the bang-bang sign (!!) to specify the variables.

```{r}
new_column = "new_age"
old_column = "age"
lung_dataset = lung_dataset %>% 
  mutate(!!new_column := scale(!!sym(old_column)))
```
